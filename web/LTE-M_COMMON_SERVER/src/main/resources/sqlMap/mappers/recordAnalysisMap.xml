<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ltem.dao.RecordAnalysisDAO">
	<select id="getGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(
				SELECT
					DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
					DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
					<if test="kpival == 8">
						IFNULL(SUM(CALL_STD_ATT_5M),0) AS STD_ATT,
						IFNULL(SUM(CALL_ATTEMPT),0) AS ATTEMPT,
						CAST(IFNULL(IF(SUM(CALL_ATTEMPT) <![CDATA[<]]> SUM(CALL_STD_ATT_5M), 0, ((SUM(CALL_ATTEMPT) - SUM(CALL_STD_ATT_5M))/SUM(CALL_STD_ATT_5M))*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
						IFNULL(SUM(CALL_SUCCESS),0) AS SUCCESS,
						CAST(IFNULL(SUM(CALL_SUCCESS)/SUM(CALL_ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
					</if>
					<if test="kpival == 9">
						IFNULL(SUM(PTT_STD_ATT_5M),0) AS STD_ATT,
						IFNULL(SUM(PTT_ATTEMPT),0) AS ATTEMPT,
						CAST(IFNULL(IF(SUM(PTT_ATTEMPT) <![CDATA[<]]> SUM(PTT_STD_ATT_5M), 0, ((SUM(PTT_ATTEMPT) - SUM(PTT_STD_ATT_5M))/SUM(PTT_STD_ATT_5M))*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
						IFNULL(SUM(PTT_SUCCESS),0) AS SUCCESS,
						CAST(IFNULL(SUM(PTT_SUCCESS)/SUM(PTT_ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
					</if>
				FROM
					TB_PM_REC 
				WHERE
					EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
					AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
					<if test='equipList != ""'>
						AND SYSTEM_ID IN
						<foreach collection = "equipList" item="value" separator="," open="(" close=")">
							#{value}
						</foreach>
					</if>
				GROUP BY
					EVENT_TIME
			) AS ALL_DATA
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			EVENT_TIME DESC
		</if>
	</select>
	
	
	<select id="getPopDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			SYSTEM_ID,
			SYSTEM_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
			<if test="kpi == 8">
				IFNULL(SUM(CALL_STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(CALL_ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL(IF(SUM(CALL_ATTEMPT) <![CDATA[<]]> SUM(CALL_STD_ATT_5M), 0, ((SUM(CALL_ATTEMPT) - SUM(CALL_STD_ATT_5M))/SUM(CALL_STD_ATT_5M))*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(CALL_SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(CALL_SUCCESS)/SUM(CALL_ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			</if>
			<if test="kpi == 9">
				IFNULL(SUM(PTT_STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(PTT_ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL(IF(SUM(PTT_ATTEMPT) <![CDATA[<]]> SUM(PTT_STD_ATT_5M), 0, ((SUM(PTT_ATTEMPT) - SUM(PTT_STD_ATT_5M))/SUM(PTT_STD_ATT_5M))*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(PTT_SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(PTT_SUCCESS)/SUM(PTT_ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			</if>
		FROM
			TB_PM_REC
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND SYSTEM_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME 
			,SYSTEM_ID
			,SYSTEM_NAME
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, SYSTEM_ID ASC
			</if>
	</select>
</mapper>