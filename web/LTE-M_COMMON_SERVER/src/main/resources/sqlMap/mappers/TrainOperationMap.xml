<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ltem.dao.TrainOperationDAO">
	<select id="getPerformanceTimeInfo" resultType="java.util.HashMap">
		SELECT
			 DATE_FORMAT(EVENT_TIME, '%Y-%m-%d %T') AS PERFORMANCE_TIME
		 FROM
			 TB_PM_PHONE AS TPP
		 WHERE TPP.PHONE_TYPE = 1
		 ORDER BY EVENT_TIME DESC
		 LIMIT 1
# 		(SELECT
# 			DATE_FORMAT(UPDATETIME, '%Y-%m-%d %T') AS MONITOR_TIME
# 		FROM
# 			TB_CO_TRAIN_TRACKING_INFO AS TCTTI
# 		ORDER BY UPDATETIME DESC
# 		LIMIT 1)
# 		UNION
# 		(SELECT
# 			DATE_FORMAT(EVENT_TIME, '%Y-%m-%d %T') AS PERFORMANCE_TIME
# 		FROM
# 			TB_PM_PHONE AS TPP
# 		WHERE TPP.PHONE_TYPE = 1
# 		ORDER BY EVENT_TIME DESC
# 		LIMIT 1)
	</select>

	<select id="getStationInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			STATION_ID,
			STATION_NAME,
			STATION_TYPE,
			STATION_DESC
		FROM
			TB_CO_STATION
	</select>

	<select id="getStationLocationInfo" resultType="java.util.HashMap">
		SELECT
			TCCL.LOCATION,
			TCCL.POSITION_X,
			TCCL.POSITION_Y,
			TCCL.STATION_FLAG,
			TCS.STATION_NAME,
			TCS.STATION_TYPE AS TRANSFER_FLAG
		FROM
			TB_CO_CELL_LOCATION AS TCCL
			LEFT JOIN TB_CO_STATION AS TCS
				ON TCS.STATION_ID = TCCL.LOCATION
		WHERE STATION_FLAG = 'Y'
		ORDER BY LOCATION * 1 ASC
	</select>

	<!--<select id="getTrainTrackingInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			TCTTI.TRAIN_NO,
			TCTTI.DIRECTION,
			TCTTI.STATION_ID,
			TCTTI.OP_CODE,
			TCTTI.TRAIN_TYPE,
			TCTTI.LAST_STATION_ID,
			TCS.STATION_NAME AS LAST_STATION_NAME,
			MAX(CASE WHEN TCPI.TRAIN_NO_UP = TCTTI.TRAIN_NO THEN TCPI.PHONE_NO END) AS PHONE_1,
			MAX(CASE WHEN TCPI.TRAIN_NO_DOWN = TCTTI.TRAIN_NO THEN TCPI.PHONE_NO END) AS PHONE_2,
			DATE_FORMAT(TCTTI.UPDATETIME, '%Y-%m-%d %T') AS MONITOR_TIME
		FROM
			TB_CO_TRAIN_TRACKING_INFO AS TCTTI
			LEFT JOIN TB_CO_STATION AS TCS
				ON TCTTI.LAST_STATION_ID = TCS.STATION_ID
			LEFT JOIN TB_CO_PHONE_INFO AS TCPI
				ON (TCTTI.TRAIN_NO = TCPI.TRAIN_NO OR TCTTI.TRAIN_NO = TCPI.TRAIN_NO_DOWN)
		GROUP BY TCTTI.TRAIN_NO
	</select>-->

	<select id="getTrainTrackingInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			TRAIN_TRACKING_INFO.TRAIN_NO,
			TRAIN_TRACKING_INFO.DIRECTION,
			TRAIN_TRACKING_INFO.STATION_ID,
			TRAIN_TRACKING_INFO.ORGAN_NO,
			TRAIN_TRACKING_INFO.OP_CODE,
			TRAIN_TRACKING_INFO.TRAIN_TYPE,
			TRAIN_TRACKING_INFO.LAST_STATION_ID,
			TRAIN_TRACKING_INFO.LAST_STATION_NAME,
			TRAIN_TRACKING_INFO.PHONE_1,
			TRAIN_TRACKING_INFO.PHONE_2,
			TRAIN_TRACKING_INFO.MONITOR_TIME
		FROM
			<!-- 현재 역사와 마지막 역사가 다른 경우는 OP CODE와 관계 없이 전부 쿼리-->
			(SELECT
				TCTTI.TRAIN_NO,
				TCTTI.DIRECTION,
				TCTTI.STATION_ID,
				TCTTI.ORGAN_NO,
				TCTTI.OP_CODE,
				TCTTI.TRAIN_TYPE,
				TCTTI.LAST_STATION_ID,
				TCS.STATION_NAME AS LAST_STATION_NAME,
				CONVERT(ORGAN_TB.ORGAN_NO + 1000, CHAR(6)) AS PHONE_1,
				CONVERT(ORGAN_TB.ORGAN_NO + 1900, CHAR(6)) AS PHONE_2,
				DATE_FORMAT(TCTTI.UPDATETIME, '%Y-%m-%d %T') AS MONITOR_TIME
			FROM
				TB_CO_TRAIN_TRACKING_INFO AS TCTTI
				LEFT JOIN TB_CO_STATION AS TCS
					ON TCTTI.LAST_STATION_ID = TCS.STATION_ID
				LEFT JOIN
					(SELECT
					IF(TCTTI2.ORGAN_NO <![CDATA[<]]> 10, TCTTI2.ORGAN_NO, SUBSTR(TCTTI2.ORGAN_NO, -2)) AS ORGAN_NO
					FROM TB_CO_TRAIN_TRACKING_INFO AS TCTTI2) AS ORGAN_TB
					ON TCTTI.ORGAN_NO = ORGAN_TB.ORGAN_NO
			WHERE
				TCTTI.STATION_ID <![CDATA[<>]]> TCTTI.LAST_STATION_ID
				AND
				(
					(TCTTI.DIRECTION = 2
					AND
					(
	  					(195 <![CDATA[<=]]> TCTTI.STATION_ID
							AND TCTTI.LAST_STATION_ID <![CDATA[<=]]> 199
							AND 0 <![CDATA[<]]> TCTTI.LAST_STATION_ID - TCTTI.STATION_ID)
						OR
						(100 <![CDATA[<=]]> TCTTI.STATION_ID
							AND TCTTI.LAST_STATION_ID <![CDATA[<=]]> 134
							AND 0 <![CDATA[<]]> TCTTI.LAST_STATION_ID - TCTTI.STATION_ID)
						OR
						(195 <![CDATA[<=]]> TCTTI.STATION_ID
							AND TCTTI.LAST_STATION_ID <![CDATA[<=]]> 134)
					))
				OR
					(TCTTI.DIRECTION = 1
					AND
					(
						(100 <![CDATA[<=]]> TCTTI.LAST_STATION_ID
							AND TCTTI.STATION_ID <![CDATA[<=]]> 134
							AND 0 <![CDATA[<]]> TCTTI.STATION_ID - TCTTI.LAST_STATION_ID)
						OR
						(195 <![CDATA[<=]]> TCTTI.LAST_STATION_ID
							AND TCTTI.STATION_ID <![CDATA[<=]]> 199
							AND 0 <![CDATA[<]]> TCTTI.STATION_ID - TCTTI.LAST_STATION_ID)
						OR
						(195 <![CDATA[>=]]> TCTTI.LAST_STATION_ID
							AND TCTTI.STATION_ID <![CDATA[<=]]> 134)
					))
				)

			GROUP BY TCTTI.TRAIN_NO

			UNION

			<!-- 현재 역사와 마지막 역사가 같은 경우-->
			<!-- OPCODE가 178(도착)인 상태에서 현재 시간과 30초 이상 차이가 나는 경우 제외 -->
			<!-- OPCODE가 179(접근)인 상태에서 현재 시간과 5분 이상 차이가 나는 경우 제외 -->
			SELECT
				TCTTI.TRAIN_NO,
				TCTTI.DIRECTION,
				TCTTI.STATION_ID,
				TCTTI.ORGAN_NO,
				TCTTI.OP_CODE,
				TCTTI.TRAIN_TYPE,
				TCTTI.LAST_STATION_ID,
				TCS.STATION_NAME AS LAST_STATION_NAME,
				CONVERT(ORGAN_TB.ORGAN_NO + 1000, CHAR(6)) AS PHONE_1,
				CONVERT(ORGAN_TB.ORGAN_NO + 1900, CHAR(6)) AS PHONE_2,
				DATE_FORMAT(TCTTI.UPDATETIME, '%Y-%m-%d %T') AS MONITOR_TIME
			FROM
				TB_CO_TRAIN_TRACKING_INFO AS TCTTI
				LEFT JOIN TB_CO_STATION AS TCS
					ON TCTTI.LAST_STATION_ID = TCS.STATION_ID
				LEFT JOIN
					(SELECT
						IF(TCTTI2.ORGAN_NO <![CDATA[<]]> 10, TCTTI2.ORGAN_NO, SUBSTR(TCTTI2.ORGAN_NO, -2)) AS ORGAN_NO
					FROM TB_CO_TRAIN_TRACKING_INFO AS TCTTI2) AS ORGAN_TB
					ON TCTTI.ORGAN_NO = ORGAN_TB.ORGAN_NO
			WHERE
				TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
				AND TCTTI.OP_CODE <![CDATA[<>]]> 177
				AND
					((TCTTI.OP_CODE = 178
					AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 60 * 5)
					OR
					(TCTTI.OP_CODE = 179
					AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 60 * 5))
			GROUP BY TCTTI.TRAIN_NO) AS TRAIN_TRACKING_INFO
		WHERE
			(TRAIN_TRACKING_INFO.STATION_ID <![CDATA[>=]]> 100
			AND TRAIN_TRACKING_INFO.STATION_ID <![CDATA[<=]]> 134)
			OR
			(TRAIN_TRACKING_INFO.STATION_ID <![CDATA[>=]]> 195
			AND TRAIN_TRACKING_INFO.STATION_ID <![CDATA[<=]]> 199)
		ORDER BY TRAIN_TRACKING_INFO.TRAIN_NO

# 		SELECT
# 		TCTTI.TRAIN_NO,
# 		TCTTI.DIRECTION,
# 		TCTTI.STATION_ID,
# 		CASE
# 		WHEN (now() - UPDATETIME) > 30 THEN 177
# 		ELSE OP_CODE END AS OP_CODE,
# 		TCTTI.TRAIN_TYPE,
# 		TCTTI.LAST_STATION_ID,
# 		TCS.STATION_NAME AS LAST_STATION_NAME,
# 		MAX(CASE WHEN TCPI.TRAIN_NO_UP = TCTTI.TRAIN_NO THEN TCPI.PHONE_NO END) AS PHONE_1,
# 		MAX(CASE WHEN TCPI.TRAIN_NO_DOWN = TCTTI.TRAIN_NO THEN TCPI.PHONE_NO END) AS PHONE_2,
# 		DATE_FORMAT(TCTTI.UPDATETIME, '%Y-%m-%d %T') AS MONITOR_TIME
# 		FROM
# 		TB_CO_TRAIN_TRACKING_INFO AS TCTTI
# 		LEFT JOIN TB_CO_STATION AS TCS
# 		ON TCTTI.LAST_STATION_ID = TCS.STATION_ID
# 		LEFT JOIN TB_CO_PHONE_INFO AS TCPI
# 		ON (TCTTI.TRAIN_NO = TCPI.TRAIN_NO OR TCTTI.TRAIN_NO = TCPI.TRAIN_NO_DOWN)
# 		WHERE
# 		TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
# 		GROUP BY TCTTI.TRAIN_NO) AS TRAIN_TRACKING_INFO
# 		ORDER BY TRAIN_TRACKING_INFO.TRAIN_NO
	</select>

	<select id="getTrainQualityInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			TRAIN_INFO.TRAIN_NO,
			TRAIN_INFO.PHONE_NO,
			TRAIN_INFO.PHONE_USE_NAME,
			TRAIN_INFO.MONITOR_TIME,
			TRAIN_INFO.SND_ATTEMPT,
			TRAIN_INFO.SND_SUCCESS,
			TRAIN_INFO.SND_ATT_RATE,
			TRAIN_INFO.SND_SUCC_RATE,
			TRAIN_INFO.SND_ATT_RATE_LEVEL,
			TRAIN_INFO.SND_SUCC_RATE_LEVEL,
			TRAIN_INFO.RECV_ATTEMPT,
			TRAIN_INFO.RECV_SUCCESS,
			TRAIN_INFO.RECV_ATT_RATE,
			TRAIN_INFO.RECV_SUCC_RATE,
			TRAIN_INFO.RECV_ATT_RATE_LEVEL,
			TRAIN_INFO.RECV_SUCC_RATE_LEVEL,
			LEAST(SND_ATT_RATE_LEVEL, SND_SUCC_RATE_LEVEL, RECV_ATT_RATE_LEVEL, RECV_SUCC_RATE_LEVEL) AS LEVEL
		FROM
			(SELECT
				 TCPI.PHONE_NO,
				 TCPI.PHONE_USE_NAME,
				 TCTTI.TRAIN_NO,
                 TCTTI.LAST_STATION_ID,
                 TCTTI.STATION_ID,
                 TCTTI.OP_CODE,
				 DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.ATTEMPT END), 0) AS SND_ATTEMPT,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.SUCCESS END), 0) AS SND_SUCCESS,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN FORMAT(TPP.ATT_RATE, 2) END), 0) AS SND_ATT_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN FORMAT(TPP.SUCC_RATE, 2) END), FORMAT(100, 2)) AS SND_SUCC_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.ATT_RATE_LEVEL END), 4) AS SND_ATT_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.SUCC_RATE_LEVEL END), 4) AS SND_SUCC_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.ATTEMPT END), 0) AS RECV_ATTEMPT,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.SUCCESS END), 0) AS RECV_SUCCESS,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN FORMAT(TPP.ATT_RATE, 2) END), 0) AS RECV_ATT_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN FORMAT(TPP.SUCC_RATE, 2) END), FORMAT(100, 2)) AS RECV_SUCC_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.ATT_RATE_LEVEL END), 4) AS RECV_ATT_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.SUCC_RATE_LEVEL END), 4) AS RECV_SUCC_RATE_LEVEL
			 FROM
				 TB_CO_TRAIN_TRACKING_INFO AS TCTTI
				 LEFT JOIN TB_CO_PHONE_INFO AS TCPI
					 ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1000, CHAR(4)) = TCPI.PHONE_NO
				 LEFT JOIN TB_PM_PHONE AS TPP
					 ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1000, CHAR(4)) = TPP.PHONE_NO
						AND TPP.EVENT_TIME = #{eventTime}
			 WHERE
				OPR_STATUS = '1'
				AND TCPI.PHONE_TYPE = '1'
				AND (
					TCTTI.STATION_ID <![CDATA[<>]]> TCTTI.LAST_STATION_ID
					OR
					(
						(TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
							AND TCTTI.OP_CODE = 179
							AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 60 * 5)
						OR
						(TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
							AND TCTTI.OP_CODE = 178
							AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 30))
					)
			 GROUP BY TCPI.PHONE_NO

			 UNION

			 SELECT
				 TCPI.PHONE_NO,
				 TCPI.PHONE_USE_NAME,
				 TCTTI.TRAIN_NO,
                 TCTTI.LAST_STATION_ID,
                 TCTTI.STATION_ID,
                 TCTTI.OP_CODE,
				 DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.ATTEMPT END), 0) AS SND_ATTEMPT,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.SUCCESS END), 0) AS SND_SUCCESS,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN FORMAT(TPP.ATT_RATE, 2) END), 0) AS SND_ATT_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN FORMAT(TPP.SUCC_RATE, 2) END), FORMAT(100, 2)) AS SND_SUCC_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.ATT_RATE_LEVEL END), 4) AS SND_ATT_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 1 THEN TPP.SUCC_RATE_LEVEL END), 4) AS SND_SUCC_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.ATTEMPT END), 0) AS RECV_ATTEMPT,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.SUCCESS END), 0) AS RECV_SUCCESS,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN FORMAT(TPP.ATT_RATE, 2) END), 0) AS RECV_ATT_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN FORMAT(TPP.SUCC_RATE, 2) END), FORMAT(100, 2)) AS RECV_SUCC_RATE,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.ATT_RATE_LEVEL END), 4) AS RECV_ATT_RATE_LEVEL,
				 IFNULL(MAX(CASE WHEN CALL_DIR = 2 THEN TPP.SUCC_RATE_LEVEL END), 4) AS RECV_SUCC_RATE_LEVEL
			 FROM
				 TB_CO_TRAIN_TRACKING_INFO AS TCTTI
				 LEFT JOIN TB_CO_PHONE_INFO AS TCPI
				 	ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1900, CHAR(4)) = TCPI.PHONE_NO
				 LEFT JOIN TB_PM_PHONE AS TPP
				 	ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1900, CHAR(4)) = TPP.PHONE_NO
					  AND TPP.EVENT_TIME = #{eventTime}
			 WHERE
				 OPR_STATUS = '1'
				 AND TCPI.PHONE_TYPE = '1'
				 AND (
					 TCTTI.STATION_ID <![CDATA[<>]]> TCTTI.LAST_STATION_ID
					 OR
					 (
						 (TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
						  AND TCTTI.OP_CODE = 179
						  AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 60 * 5)
						 OR
						 (TCTTI.STATION_ID = TCTTI.LAST_STATION_ID
						  AND TCTTI.OP_CODE = 178
						  AND (now() - TCTTI.UPDATETIME) <![CDATA[<=]]> 1 * 30))
					 )
			 GROUP BY TCPI.PHONE_NO) AS TRAIN_INFO
		WHERE
			TRAIN_INFO.TRAIN_NO IN
			<foreach collection = "trainNo" item="value" separator="," open="(" close=")">
				#{value}
			</foreach>
		ORDER BY TRAIN_INFO.TRAIN_NO, TRAIN_INFO.PHONE_NO
	</select>


	<select id="getTrainQualityTrendAll" resultType="java.util.HashMap" parameterType="java.util.HashMap">
			SELECT
				'' AS TRAIN_NO,
				'' AS PHONE_NO,
				SUM(TPP.ATTEMPT) AS ATTEMPT,
				SUM(TPP.SUCCESS) AS SUCCESS,
				FORMAT(SUM(TPP.SUCCESS) / SUM(TPP.ATTEMPT) * 100, 2) AS SUCC_RATE,
				DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME,
				UNIX_TIMESTAMP(TPP.EVENT_TIME) AS EVENT_TIME
			FROM TB_PM_PHONE AS TPP
			WHERE
				TPP.PHONE_TYPE = 1
				AND TPP.EVENT_TIME  <![CDATA[>=]]> #{startEventTime}
				AND TPP.EVENT_TIME  <![CDATA[<=]]> #{endEventTime}
				AND TPP.CALL_DIR = #{callDir}
				AND TPP.PHONE_NO IN
				<foreach collection = "phoneLists" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			GROUP BY MONITOR_TIME, CALL_DIR
	</select>

	<select id="getTrainPhoneInfo" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			TCPI.PHONE_NO
		FROM
			TB_CO_TRAIN_TRACKING_INFO AS TCTTI
			LEFT JOIN TB_CO_PHONE_INFO AS TCPI
				ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1000, CHAR(4)) = TCPI.PHONE_NO
		WHERE
			TCTTI.TRAIN_NO = #{trainNo}
			AND TCPI.PHONE_TYPE = '1'

		UNION ALL

		SELECT
			TCPI.PHONE_NO
		FROM
			TB_CO_TRAIN_TRACKING_INFO AS TCTTI
			LEFT JOIN TB_CO_PHONE_INFO AS TCPI
				ON CONVERT(IF(TCTTI.ORGAN_NO <![CDATA[<]]> 10, TCTTI.ORGAN_NO, SUBSTR(TCTTI.ORGAN_NO, -2)) + 1900, CHAR(4)) = TCPI.PHONE_NO
		WHERE
			TCTTI.TRAIN_NO = #{trainNo}
			AND TCPI.PHONE_TYPE = '1'
	</select>

	<select id="getTrainQualityTrend" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			 #{trainNo} AS TRAIN_NO,
			 #{phoneNo} AS PHONE_NO,
			 SUM(TPP.ATTEMPT) AS ATTEMPT,
			 SUM(TPP.SUCCESS) AS SUCCESS,
			 FORMAT(SUM(TPP.SUCCESS) / SUM(TPP.ATTEMPT) * 100, 2) AS SUCC_RATE,
			 DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME
		FROM TB_PM_PHONE AS TPP
		WHERE
			TPP.PHONE_TYPE = 1
			AND TPP.EVENT_TIME  <![CDATA[>=]]> #{startEventTime}
			AND TPP.EVENT_TIME  <![CDATA[<=]]> #{endEventTime}
			AND TPP.PHONE_NO = #{phoneNo}
			AND TPP.CALL_DIR = #{callDir}
		GROUP BY MONITOR_TIME, CALL_DIR
	</select>

	<select id="getLastTrainQualityTrendAll" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			PERF_INFO.TRAIN_NO,
			PERF_INFO.PHONE_NO,
			PERF_INFO.SEND_ATTEMPTS,
			PERF_INFO.SEND_SUCCESS,
			CASE WHEN PERF_INFO.SEND_ATTEMPTS = 0 THEN FORMAT(100, 2) ELSE FORMAT(PERF_INFO.SEND_SUCCESS / PERF_INFO.SEND_ATTEMPTS * 100, 2) END AS SEND_SUCC_RATES,
			PERF_INFO.RECV_ATTEMPTS,
			PERF_INFO.RECV_SUCCESS,
			CASE WHEN PERF_INFO.RECV_ATTEMPTS = 0 THEN FORMAT(100, 2) ELSE FORMAT(PERF_INFO.RECV_SUCCESS / PERF_INFO.RECV_ATTEMPTS * 100, 2) END AS RECV_SUCC_RATES,
			PERF_INFO.MONITOR_TIME
		FROM (
				SELECT
					 '' AS TRAIN_NO,
					 '' AS PHONE_NO,
					 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 1 THEN TPP.ATTEMPT END), 0) AS SEND_ATTEMPTS,
					 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 1 THEN TPP.SUCCESS END), 0) AS SEND_SUCCESS,
					 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 2 THEN TPP.ATTEMPT END), 0) AS RECV_ATTEMPTS,
					 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 2 THEN TPP.SUCCESS END), 0) AS RECV_SUCCESS,
					 DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME
				FROM TB_PM_PHONE AS TPP
				WHERE
					TPP.PHONE_TYPE = 1
					AND TPP.EVENT_TIME = #{eventTime}
				GROUP BY MONITOR_TIME) AS PERF_INFO
	</select>

	<select id="getLastTrainQualityTrendPhone" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		SELECT
			PERF_INFO.TRAIN_NO,
			PERF_INFO.PHONE_NO,
			PERF_INFO.SEND_ATTEMPTS,
			PERF_INFO.SEND_SUCCESS,
			CASE WHEN PERF_INFO.SEND_ATTEMPTS = 0 THEN FORMAT(100, 2) ELSE FORMAT(PERF_INFO.SEND_SUCCESS / PERF_INFO.SEND_ATTEMPTS * 100, 2) END AS SEND_SUCC_RATE,
			PERF_INFO.RECV_ATTEMPTS,
			PERF_INFO.RECV_SUCCESS,
			CASE WHEN PERF_INFO.RECV_ATTEMPTS = 0 THEN FORMAT(100, 2) ELSE FORMAT(PERF_INFO.RECV_SUCCESS / PERF_INFO.RECV_ATTEMPTS * 100, 2) END AS RECV_SUCC_RATE,
			PERF_INFO.MONITOR_TIME
		FROM
			(SELECT
				 #{trainNo} AS TRAIN_NO,
				 #{phoneNo} AS PHONE_NO,
				 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 1 THEN TPP.ATTEMPT END), 0) AS SEND_ATTEMPTS,
				 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 1 THEN TPP.SUCCESS END), 0) AS SEND_SUCCESS,
				 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 2 THEN TPP.ATTEMPT END), 0) AS RECV_ATTEMPTS,
				 IFNULL(SUM(CASE WHEN TPP.CALL_DIR = 2 THEN TPP.SUCCESS END), 0) AS RECV_SUCCESS,
				 DATE_FORMAT(TPP.EVENT_TIME, '%Y-%m-%d %T') AS MONITOR_TIME
			 FROM TB_PM_PHONE AS TPP
			 WHERE
				 TPP.PHONE_TYPE = 1
				 AND TPP.EVENT_TIME = #{eventTime}
				 AND PHONE_NO = #{eventTime}
			 GROUP BY MONITOR_TIME) AS PERF_INFO;
	</select>
</mapper>