<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ltem.dao.EpcAnalysisDAO">
	<select id="getMmeGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(SELECT
				DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
				DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
				IFNULL(SUM(STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL((SUM(ATTEMPT) - SUM(STD_ATT_5M))/SUM(STD_ATT_5M), 0)*100 AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(SUCCESS)/SUM(ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			FROM
				<if test='kpival == "1"'>
				TB_PM_MME_ATTACH
				</if>
				<if test='kpival == "2"'>
				TB_PM_MME_SR
				</if>
				<if test='kpival == "3"'>
				TB_PM_MME_SRMT
				</if>
			WHERE
				EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
				AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
				<if test='equipList != ""'>
					AND MME_ID IN
					<foreach collection = "equipList" item="value" separator="," open="(" close=")">
						#{value}
					</foreach>
				</if>
			GROUP BY
				EVENT_TIME) AS ALL_DATA
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			ALL_DATA.EVENT_TIME DESC
		</if>
	</select>
	<select id="getPgwGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(SELECT
				DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
				DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
				IFNULL(SUM(STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL((SUM(ATTEMPT) - SUM(STD_ATT_5M))/SUM(STD_ATT_5M), 0)*100 AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(SUCCESS)/SUM(ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			FROM
				<if test='kpival == "1"'>
				TB_PM_PGW_CREATE
				</if>
				<if test='kpival == "2"'>
				TB_PM_PGW_DELETE
				</if>
				<if test='kpival == "3"'>
				TB_PM_PGW_MODIFY
				</if>
			WHERE
				EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
				AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
				<if test='equipList != ""'>
					AND PGW_ID IN
					<foreach collection = "equipList" item="value" separator="," open="(" close=")">
						#{value}
					</foreach>
				</if>
			GROUP BY
				EVENT_TIME) AS ALL_DATA
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			ALL_DATA.EVENT_TIME DESC
		</if>
	</select>
	<select id="getSgwGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(SELECT
				DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
				DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
				IFNULL(SUM(STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL((SUM(ATTEMPT) - SUM(STD_ATT_5M))/SUM(STD_ATT_5M), 0)*100 AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(SUCCESS)/SUM(ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			FROM
				<if test='kpival == "1"'>
				TB_PM_SGW_ATTACH
				</if>
				<if test='kpival == "2"'>
				TB_PM_SGW_DELETE				
				</if>
				<if test='kpival == "3"'>
				TB_PM_SGW_MODIFY
				</if>
			WHERE
				EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
				AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
				<if test='equipList != ""'>
					AND SGW_ID IN
					<foreach collection = "equipList" item="value" separator="," open="(" close=")">
						#{value}
					</foreach>
				</if>
			GROUP BY
				EVENT_TIME) AS ALL_DATA
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			ALL_DATA.EVENT_TIME DESC
		</if>
	</select>
	<select id="getHpsGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(SELECT
				DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
				DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
				IFNULL(SUM(STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL((SUM(ATTEMPT) - SUM(STD_ATT_5M))/SUM(STD_ATT_5M), 0)*100 AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(SUCCESS)/SUM(ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			FROM
				<if test = 'kpival == "1"'>  
					TB_PM_HSS_S6A
				</if>
				
				<if test = 'kpival == "2"'>
					TB_PM_HSS_CX
				</if>
				<if test = 'kpival == "3"'>  
					TB_PM_PCRF_GX
				</if>
				
				<if test = 'kpival == "4"'>
					TB_PM_PCRF_RX
				</if>
				
				
			WHERE
				EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
				AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
				<if test='equipList != ""'>
					<!-- HSS -->  
					<if test = 'kpival == "1" or kpival == "2"'>  
						AND HSS_ID IN
					</if>
					
					<!-- PCRF -->
					<if test = 'kpival == "3" or kpival == "4"'>  
						AND PCRF_ID IN
					</if>
					<foreach collection = "equipList" item="value" separator="," open="(" close=")">
						#{value}
					</foreach>
				</if>
			GROUP BY
				EVENT_TIME) AS ALL_DATA 
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			ALL_DATA.EVENT_TIME DESC
		</if>
	</select>
	<select id="getPcrfGridData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			ALL_DATA.EVENT_TIME,
			ALL_DATA.COMP_TIME,
			ALL_DATA.STD_ATT,
			ALL_DATA.ATTEMPT,
			ALL_DATA.ATT_RATE,
			ALL_DATA.SUCCESS,
			ALL_DATA.SUCC_RATE
		FROM
			(SELECT
				DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
				DATE_FORMAT(EVENT_TIME,'%Y%m%d%H%i') AS COMP_TIME,
				IFNULL(SUM(STD_ATT_5M),0) AS STD_ATT,
				IFNULL(SUM(ATTEMPT),0) AS ATTEMPT,
				CAST(IFNULL((SUM(ATTEMPT) - SUM(STD_ATT_5M))/SUM(STD_ATT_5M), 0)*100 AS DECIMAL(12,2)) AS ATT_RATE,
				IFNULL(SUM(SUCCESS),0) AS SUCCESS,
				CAST(IFNULL(SUM(SUCCESS)/SUM(ATTEMPT)*100,100) AS DECIMAL(12,2)) AS SUCC_RATE
			FROM
				TB_PM_PCRF
			WHERE
				EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
				AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
				AND KPI_TYPE = #{kpival}
				<if test='equipList != ""'>
					AND PCRF_ID IN
					<foreach collection = "equipList" item="value" separator="," open="(" close=")">
						#{value}
					</foreach>
				</if>
			GROUP BY
				EVENT_TIME) AS ALL_DATA
		ORDER BY
		<if test = 'sortOption.size() > 0'>
			<foreach collection="sortOption" item="option" separator=",">
				${option.colName} ${option.order}
			</foreach>
		</if>
		<if test = 'sortOption.size() == 0'>
			ALL_DATA.EVENT_TIME DESC
		</if>
	</select>
	
	
	<select id="getPopMmeDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			MME_ID AS NE_ID,
			MME_NAME AS NE_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			IFNULL(STD_ATT_5M,0) AS STD_ATT,
			IFNULL(ATTEMPT,0) AS ATTEMPT,
			CAST(IFNULL((((ATTEMPT - STD_ATT_5M)/STD_ATT_5M)*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
			<if test='kpi != "2"'>
			IFNULL(ANSWER,0) AS ANSWER,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(ANS_RATE AS DECIMAL(12,2)) END AS ANS_RATE,
			</if>
			IFNULL(SUCCESS,0) AS SUCCESS,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(SUCC_RATE AS DECIMAL(12,2)) END AS SUCC_RATE
		FROM
			<if test='kpi == "1"'>
			TB_PM_MME_ATTACH
			</if>
			<if test='kpi == "2"'>
			TB_PM_MME_SGSAP
			</if>
			<if test='kpi == "3"'>
			TB_PM_MME_SR
			</if>
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND MME_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME,MME_ID
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, NE_ID
			</if>
	</select>
	<select id="getPopPgwDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			PGW_ID AS NE_ID,
			PGW_NAME AS NE_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			IFNULL(STD_ATT_5M,0) AS STD_ATT,
			IFNULL(ATTEMPT,0) AS ATTEMPT,
			CAST(IFNULL((((ATTEMPT - STD_ATT_5M)/STD_ATT_5M)*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
			IFNULL(SUCCESS,0) AS SUCCESS,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(SUCC_RATE AS DECIMAL(12,2)) END AS SUCC_RATE
		FROM
			<if test='kpi == "1"'>
			TB_PM_PGW_CREATE
			</if>
			<if test='kpi == "2"'>
			TB_PM_PGW_DELETE
			</if>
			<if test='kpi == "3"'>
			TB_PM_PGW_MODIFY
			</if>
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND PGW_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME,PGW_ID
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, NE_ID
			</if>
	</select>
	<select id="getPopSgwDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			SGW_ID AS NE_ID,
			SGW_NAME AS NE_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			IFNULL(STD_ATT_5M,0) AS STD_ATT,
			IFNULL(ATTEMPT,0) AS ATTEMPT,
			CAST(IFNULL((((ATTEMPT - STD_ATT_5M)/STD_ATT_5M)*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
			IFNULL(SUCCESS,0) AS SUCCESS,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(SUCC_RATE AS DECIMAL(12,2)) END AS SUCC_RATE
		FROM
			<if test='kpi == "1"'>
			TB_PM_SGW_ATTACH
			</if>
			<if test='kpi == "2"'>
			TB_PM_SGW_DELETE
			</if>
			<if test='kpi == "3"'>
			TB_PM_SGW_MODIFY
			</if>
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND SGW_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME,SGW_ID
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, NE_ID
			</if>
	</select>
	<select id="getPopHssDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			HSS_ID AS NE_ID,
			HSS_NAME AS NE_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			IFNULL(STD_ATT_5M,0) AS STD_ATT,
			IFNULL(ATTEMPT,0) AS ATTEMPT,
			CAST(IFNULL((((ATTEMPT - STD_ATT_5M)/STD_ATT_5M)*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
			IFNULL(SUCCESS,0) AS SUCCESS,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(SUCC_RATE AS DECIMAL(12,2)) END AS SUCC_RATE
		FROM
			<if test='kpi == "1"'>
			TB_PM_HSS_S6A
			</if>
			<if test='kpi == "2"'>
			TB_PM_HSS_CX
			</if>
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')  
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND HSS_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME, HSS_ID
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, NE_ID
			</if>
	</select>
	<select id="getPopPcrfDetailData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			PCRF_ID AS NE_ID,
			PCRF_NAME AS NE_NAME,
			DATE_FORMAT(EVENT_TIME,'%Y-%m-%d %H:%i') AS EVENT_TIME,
			IFNULL(STD_ATT_5M,0) AS STD_ATT,
			IFNULL(ATTEMPT,0) AS ATTEMPT,
			CAST(IFNULL((((ATTEMPT - STD_ATT_5M)/STD_ATT_5M)*100),0) AS DECIMAL(12,2)) AS ATT_RATE,
			IFNULL(SUCCESS,0) AS SUCCESS,
			CASE WHEN ATTEMPT = 0 THEN 100 WHEN ATTEMPT IS NULL THEN 100 ELSE CAST(SUCC_RATE AS DECIMAL(12,2)) END AS SUCC_RATE
		FROM
			<if test='kpi == "3"'>
			TB_PM_PCRF_GX
			</if> 
			<if test='kpi == "4"'>
			TB_PM_PCRF_RX
			</if>
		WHERE
			EVENT_TIME <![CDATA[>=]]> STR_TO_DATE(#{startDateTime},'%Y%m%d%H%i')
			AND EVENT_TIME <![CDATA[<=]]> STR_TO_DATE(#{endDateTime},'%Y%m%d%H%i')
			<if test='equipList != ""'>
				AND PCRF_ID IN
				<foreach collection = "equipList" item="value" separator="," open="(" close=")">
					#{value}
				</foreach>
			</if>
		GROUP BY
			EVENT_TIME, PCRF_ID
		ORDER BY 
			<if test = 'sortOption.size() > 0'>
				<foreach collection="sortOption" item="option" separator=",">
					${option.colName} ${option.order}
				</foreach>
			</if>
			<if test = 'sortOption.size() == 0'>
				EVENT_TIME DESC, NE_ID
			</if>
	</select>
</mapper>